# 査察システム設計書

## 概要

査察は3ヶ月（84日）ごとの**ゲームオーバー判定ポイント**。
ローグライト設計で、不合格 = 召還（ゲームオーバー）→ リトライ。

```
Q1(84日) → Q2(168日) → Q3(252日) → Q4最終(336日)
  ↓失敗      ↓失敗       ↓失敗        ↓結果
 召還ED     召還ED      召還ED     真/好/普/バッドED
```

---

## 査察ルール

### 基本ルール

- 査察日（Day 84/168/252）の朝に**自動発火**する（プレイヤーの状態に関わらず必ず発生）
- 全評価項目がC基準以上で**合格**。1項目でもC未満なら**不合格（召還）**
- 合格時は等級（S/A/B/C）に応じた報酬
- 最終査察（Day 336）はエンディング分岐のみ（召還なし）

### 等級の決定

全項目の等級のうち**最低のもの**が総合等級になる。

---

## 評価基準

> **注意**: 以下の数値は暫定値。アイテム・日数のバランス調整後に再調整予定。

### Q1: 基礎確認（Day 84）

テーマ:「先生として認められるか」

| 項目 | D(召還) | C(合格) | B | A | S |
|------|---------|---------|---|---|---|
| 錬金術Lv | ~3 | **4** | 5 | 6 | 7 |
| 依頼完了数 | ~6 | **8** | 10 | 12 | 15 |
| 調合回数 | ~19 | **25** | 35 | 45 | 55 |

設計意図: 84日間ほぼ毎日調合し、コンスタントに依頼をこなす必要がある。序盤で日数を浪費すると落ちる。初見プレイヤーの半数が落ちる想定。

### Q2: 中間評価（Day 168）

テーマ:「村に必要とされているか」

| 項目 | D(召還) | C(合格) | B | A | S |
|------|---------|---------|---|---|---|
| 錬金術Lv | ~5 | **7** | 8 | 9 | 10 |
| 依頼完了数 | ~13 | **18** | 22 | 26 | 30 |
| 村発展度 | ~24 | **30** | 38 | 46 | 55 |
| 名声 | ~24 | **30** | 40 | 50 | 60 |

設計意図: レシピ選択の効率化、採取隊の活用、依頼スケジューリングが問われる。Q1通過者でもここで脱落するケースが多い最大の壁。

### Q3: 最終準備確認（Day 252）

テーマ:「成果を出せているか」

| 項目 | D(召還) | C(合格) | B | A | S |
|------|---------|---------|---|---|---|
| 錬金術Lv | ~7 | **9** | 10 | 11 | 12 |
| 依頼完了数 | ~22 | **28** | 33 | 38 | 43 |
| 村発展度 | ~40 | **50** | 58 | 66 | 75 |
| 名声 | ~40 | **50** | 58 | 66 | 75 |
| 最高品質 | ~54 | **65** | 72 | 80 | 88 |

設計意図: 高レベルレシピへの到達と品質管理が求められる。装備効果やレシピツリーの知識が必要。

### Q4: 最終査察（Day 336）

**召還判定なし**。到達した時点で物語は完結し、ステータスに応じてエンディングが分岐する。

| エンディング | 条件 |
|-------------|------|
| 真ED「この村の錬金術師」 | 特産品完成 + rep >= 70 + lv >= 15 + vd >= 60 |
| 好ED「芽吹きの日」 | 特産品完成 + rep >= 50 + lv >= 10 |
| 普通ED「旅立ちの朝」 | rep >= 30 + lv >= 8 + quest >= 15 |
| バッドED「帰り道」 | 上記いずれも満たさない |

---

## 等級報酬

高い等級を取ると次の四半期が楽になるフィードバックループ。

| 等級 | 支援金(Q1/Q2/Q3) | 素材 | 名声 |
|------|-----------------|------|------|
| S | 500/800/1200G | レア素材 | +10 |
| A | 300/500/800G | 中級素材 | +5 |
| B | 150/250/400G | 基礎素材 | +2 |
| C | 0 | なし | 0 |

---

## ヴィクト（ライバル）との比較演出

査察結果画面にはヴィクトの等級が表示される。ヴィクトの等級は固定:

| 査察 | ヴィクトの等級 | 演出意図 |
|------|-------------|---------|
| Q1 | A | 先行されている焦り |
| Q2 | A | まだ差がある |
| Q3 | B | ヴィクトも壁にぶつかっている。追いつけるチャンス |

プレイヤーの等級との比較で査察官のコメントが変化:
- 下回り: 「率直に言って、ヴィクト君の方が進捗は良い」
- 同等: 「ヴィクト君と同等の進捗ですね」
- 上回り: 「ヴィクト君を上回る成果です。驚きました」

---

## UI

### 査察レポート画面

査察日に表示される専用画面。アチーブメントダイアログではなく独立したコンポーネント。

```
┌─────────────────────────────────────┐
│    師匠組合 第1四半期 査察報告書      │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 錬金術レベル    Lv.5  ■■■■□ A │  │
│  │ 依頼完了数      9件   ■■■□□ B │  │
│  │ 調合回数        38回  ■■■■□ A │  │
│  └───────────────────────────────┘  │
│                                     │
│  総合評価:  【 B 】                  │
│  ヴィクトの評価: 【 A 】             │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 査察官「基礎は身についている    │  │
│  │ ようですね。しかし、ヴィクト君  │  │
│  │ の方が進捗は良い。               │  │
│  │ 次は村への貢献を期待します」     │  │
│  └───────────────────────────────┘  │
│                                     │
│  報酬: 組合支援金 150G               │
│        ハルマム草(品質70) x2         │
│                                     │
│         [ 確認 ]                    │
└─────────────────────────────────────┘
```

### ゲームオーバー画面（召還ED）

不合格時は**何が足りなかったか**を明示してリトライ意欲を促す。

```
┌─────────────────────────────────────┐
│         師匠組合 召還通知            │
│                                     │
│  第2四半期査察の結果、派遣錬金術師  │
│  としての活動継続を認められません   │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 錬金術レベル  Lv.5  ✗ (C: 7) │  │
│  │ 依頼完了数    14件  ✗ (C: 18)│  │
│  │ 村発展度      32    ○        │  │
│  │ 名声          28    ✗ (C: 30)│  │
│  └───────────────────────────────┘  │
│                                     │
│  査察官「残念です。もう少し         │
│  調合と依頼に力を入れていれば……」  │
│                                     │
│  到達日数: 168日 / 336日            │
│                                     │
│  [ もう一度挑戦する ]               │
└─────────────────────────────────────┘
```

---

## 実装方針

### 発火方式

現在のアチーブメント方式（条件未達で発火しない）は査察に不適合。
`gameLoop.ts` の `processMorningPhase()` に査察日チェックを追加し、**特定日に必ず発火**させる。

```
processMorningPhase() {
  ...既存処理...
  if (INSPECTION_DAYS.includes(state.day)) {
    triggerInspection(state.day);
  }
}
```

### 新規ファイル

| ファイル | 役割 |
|---------|------|
| `src/lib/services/inspection.ts` | 評価ロジック（等級計算、報酬付与、合否判定） |
| `src/components/InspectionReport.svelte` | 査察レポート画面（合格時） |
| `src/components/InspectionGameOver.svelte` | 召還画面（不合格時） |

### 既存ファイルへの変更

| ファイル | 変更内容 |
|---------|---------|
| `src/lib/services/gameLoop.ts` | 朝フェーズに査察チェック追加 |
| `src/lib/models/types.ts` | 査察関連の型定義追加 |
| `src/lib/stores/game.ts` | 査察結果の状態管理 |
| `src/components/EndingScreen.svelte` | エンディング条件を story_events_design.md に合わせて更新 |
| `src/routes/+page.svelte` | 査察レポート/召還画面の表示制御 |

### 既存アチーブメントとの関係

Q1-Q3の既存査察アチーブメント（`ach_story_q1_checkpoint` 等）は以下の方針で扱う:

- 査察**前の予告**イベント（`ach_story_report_notice` 等）はそのまま維持
- 査察**当日**のアチーブメント（`ach_story_q1_checkpoint` 等）は削除し、専用の査察システムに置き換え
- 査察**後**のイベント（`ach_story_rival_appear` 等）は prerequisite を査察通過フラグに変更

---

## ローグライト拡張（将来候補）

最低限の実装としては「ゲームオーバー → リスタート」で十分。
将来的に追加可能な要素:

| 要素 | 内容 |
|------|------|
| ベスト記録 | 最高到達査察、最高等級の記録保持 |
| 知識の引き継ぎ | 一度見たレシピはヒントが出る |
| 初期ボーナス選択 | 周回ごとに「師匠からの餞別」を選べる（素材/レシピ/所持金） |
| 実績解除 | 「Q1をS評価で通過」→ 次回以降の開始時ボーナス |
